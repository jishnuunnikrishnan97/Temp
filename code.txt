import fitz
import PyPDF2
import os
import pytesseract
from PIL import Image
import io

# Step 1: Create lists
not_a_pdf = []
corrupted = []
image_pdf = []
no_tables_to_extract = []
IR_FITCH = []
CRISIL = []
ICRA = []
CARE = []

# Step 2: Read only PDF files
folder_path = 'path_to_your_folder'
for filename in os.listdir(folder_path):
    if filename.endswith('.pdf'):
        # Step 3: Check if the PDF is readable
        try:
            with open(os.path.join(folder_path, filename), 'rb') as pdf_file:
                pdf_reader = PyPDF2.PdfFileReader(pdf_file)
                doc = fitz.open(pdf_file)
                page = doc[0]
                page_images = page.get_images(full=True)
                page_text = page.get_text()
                
                # Step 4: Check if pages are images or text is readable
                if len(page_images) > 0:
                    image_pdf.append(filename)
                
                # Step 5: Convert the first page to image and extract text from the top 10%
                image = page.get_pixmap()
                img_bytes = image.get_pil_image().tobytes()
                img = Image.open(io.BytesIO(img_bytes))
                
                # Crop 10% from the top
                width, height = img.size
                cropped_img = img.crop((0, 0, width, int(0.1 * height)))
                
                # Use pytesseract to extract text from the cropped image
                cropped_text = pytesseract.image_to_string(cropped_img)
                
                # Step 6: Check for specific strings
                if any(keyword in cropped_text.lower() for keyword in ['fitch', 'india rating']):
                    IR_FITCH.append(filename)
                if 'crisil' in cropped_text.lower():
                    CRISIL.append(filename)
                if 'icra' in cropped_text.lower():
                    ICRA.append(filename)
                if 'care' in cropped_text.lower():
                    CARE.append(filename)
                    
        except (PyPDF2.utils.PdfReadError, fitz.DocumentError):
            corrupted.append(filename)
    else:
        not_a_pdf.append(filename)

# You can now access the lists with the respective filenames as needed.
